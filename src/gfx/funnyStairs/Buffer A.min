#version 450
uniform sampler2D iChannel0;uniform vec2 iResolution;uniform float iTime;uniform int iFrame;const vec3 v=vec3(1.,0.,-1.);const float m=3.14159,f=1.618,s=120.,y=60./s;mat3 i=mat3(1.),r=mat3(1.);float x,e;const float a=90.;float n(float v,float y,float m){float s=max(m-abs(v-y),0.)/m;return min(v,y)-s*s*s*m*(1./6.);}float p(float v,float f,float y){return v+f-n(v,f,y);}float t(float y,float v,float m){vec2 f=vec2(v,abs(y)-.5*m);return min(max(f.x,f.y),0.)+length(max(f,0.));}void h(in vec2 v,out float f,out vec2 i){vec2 y=vec2(v.x*1.2,v.y+v.x*.6),m=floor(y),s=fract(y);float x=mod(m.x+m.y,3.),e=step(1.,x),a=step(2.,x);vec2 l=step(s.xy,s.yx);f=dot(l,1.-s.yx+e*(s.x+s.y-1.)+a*(s.yx-2.*s.xy));i=m+e-a*l;i=vec2(i.x/1.2,i.y);i=vec2(i.x,i.y-i.x*.6);}mat3 h(in vec3 y){return mat3(v.xyyy,cos(y.x),sin(y.x),0.,-sin(y.x),cos(y.x))*mat3(cos(y.y),0.,-sin(y.y),v.yxy,sin(y.y),0.,cos(y.y))*mat3(cos(y.z),-sin(y.z),0.,sin(y.z),cos(y.z),v.yyyx);}float n(vec2 v){vec3 f=fract(vec3(v.xyx)*.1031);f+=dot(f,f.yzx+33.33);return fract((f.x+f.y)*f.z);}float p(vec2 f){vec2 y=floor(f);f=fract(f);f=smoothstep(v.yy,v.xx,f);vec2 i=vec2(n(y),n(y+v.xy)),s=vec2(n(y+v.yx),n(y+v.xx));i=v.zz+2.*mix(i,s,f.y);return mix(i.x,i.y,f.x);}float h(vec2 y,float m,float v,float f){float i=0.,s=1.,x=0.,c;for(float r=m;r<v;r*=2.)i+=s*p(r*y-2.*iTime),s*=f,x+=1.;return i*(1.-f)/(1.-pow(f,x));}vec3 t(vec3 v){vec4 i=vec4(1.,2./3.,1./3.,3.);vec3 y=abs(fract(v.xxx+i.xyz)*6.-i.www);return v.z*mix(i.xxx,clamp(y-i.xxx,0.,1.),v.y);}vec3 d(vec3 v){vec4 f=vec4(0.,-1./3.,2./3.,-1.),i=mix(vec4(v.zy,f.wz),vec4(v.yz,f.xy),step(v.z,v.y)),m=mix(vec4(i.xyw,v.x),vec4(v.x,i.yzx),step(i.x,v.x));float s=m.x-min(m.w,m.y),y=1e-10;return vec3(abs(m.z+(m.w-m.y)/(6.*s+y)),s/(m.x+y),m.x);}float d(vec3 y,vec3 v){vec3 f=abs(y)-v;return length(max(f,0.))+min(max(f.x,max(f.y,f.z)),0.);}float h(in vec2 v,in float y){float f=2.*m;vec2 i=mod(vec2(atan(v.y,v.x),length(v)/y),f);float x=abs(i.y-i.x);return y*min(x,f-x);}float d(in vec2 v,in vec2 y,in vec2 f){vec2 i=f-y;return length(v-mix(y,f,clamp(dot(v-y,i)/dot(i,i),0.,1.)));}float d(in vec2 y,in float f,in float i,in float x){x*=2.;float a=atan(y.y,y.x),s=m/x,c=mod(a+m,2.*s),e=mod(round((a+m-c)*.5/s),2.),l=s,r=mix(l,-l,e);vec2 z=f*vec2(cos(s-r),sin(s-r)),o=i*vec2(cos(s+r),sin(s+r)),t=o-z,d=normalize(o-z).yx*v.xz,n=length(y)*vec2(cos(c),sin(c));float S=dot(n-z,t)/dot(t,t),u=mix(1.,-1.,e)*dot(n-z,d);if(S<0.)return sign(u)*length(n-z);else if(S>1.)return sign(u)*length(n-o);else return u;}float c(vec2 v){return max(v.x,v.y);}float l(vec2 v){return min(max(max(max(max(min(max(max(c(abs(vec2(abs(abs(v.x)-.25)-.25,v.y))-vec2(.2)),-c(abs(vec2(v.x+.5,abs(abs(v.y)-.05)-.05))-vec2(.12,.02))),-c(abs(vec2(abs(v.x+.5)-.1,v.y-.05*sign(v.x+.5)))-vec2(.02,.07))),c(abs(vec2(v.x+.5,v.y+.1))-vec2(.08,.04))),-c(abs(vec2(v.x,v.y-.04))-vec2(.02,.08))),-c(abs(vec2(v.x,v.y+.1))-vec2(.02))),-c(abs(vec2(v.x-.5,v.y))-vec2(.08,.12))),-c(abs(vec2(v.x-.5,v.y-.05))-vec2(.12,.07))),c(abs(vec2(v.x-.5,v.y))-vec2(.02,.08)));}struct SceneData{float material,dist,accumulation,reflectivity,transmittivity,specular,diffuse;};SceneData S(float y){return SceneData(1.3,y,1.,.1,.1,.5,1.);}SceneData S(SceneData v,SceneData y){if(v.dist<y.dist)return v;return y;}float u;float S(vec3 v,float y,float x,float f){float i=mix(2.,12.,.5+.5*x)*y*x;mat2 m=mat2(cos(i),sin(i),-sin(i),cos(i));float s=-abs(d(m*(v.xy-vec2(x,f)*.5),abs(x+.1*y),abs(f-.1*y),round(5.+x+f)))+.01-.1*y,a=mod(s,.2)-.189;u=s-a;return a;}float c(vec3 v,float y,float f,float x){return-1.+h(v.xy-f*.3,3.,10.,.45)-3.*y;}float l(vec3 v,float y,float x,float f){mat2 i=mat2(cos(iTime),sin(iTime),-sin(iTime),cos(iTime));return-abs(h(i*i*v.xy-.3*x,mix(.05,.1,.5+.5*x)))-.3*y+.01*x;}float n(vec3 v,float y,float f,float i){float s=.3,m=-abs(mod(l(v.xy-y*.4),s)+.5*s-.4-.2*f-.5*y)+.01+.01*x+.001*y;return m;}float p(vec3 v,float y,float f,float x){vec2 i;float m=2.+2.*f,s;h(m*v.xy,s,i);return-abs(s/m)+.01-.5*y;}float t(vec3 v,float y,float f,float i){const float s=.4,e=m/6.,z=.5;vec2 a=vec2(atan(v.y,v.x),length(v.xy));float l=mod(a.x,e)-.5*e,c=a.x-l,r=mod(a.y,z)-.5*z,n=a.y-r;vec2 t=(n-.2*sin(m*y-f))*vec2(cos(c),sin(c)),o=a.y*vec2(cos(a.x),sin(a.x));float S=-length(mat2(cos(iTime-y),sin(iTime-y),-sin(iTime-y),cos(iTime-y))*(v.xy-t))+.001+.1*(.5+.5*i)+.05*(.6+.4*x)+.01*y*(.5+.5*f);return mod(S,.2)-.189;}float c(vec3 y,float f){float i=p(.5*e*v.xx-f),s=p(.5*e*v.xx+1337.-f),x=1.-clamp(iTime/a,0.,1.);const float m=6.;if(x<1.5/m)return mix(S(y,f,i,s),-abs(length(y.xy)-.3+.05*f)+.01-.5*f,smoothstep(.1/m,0.,x)*smoothstep(1.4/m,1.5/m,x));else if(x<3./m)return mix(c(y,f,i,s),-abs(length(y.xy)-.3+.05*f)+.01-.5*f,smoothstep(1.6/m,1.5/m,x)*smoothstep(2.9/m,3./m,x));else if(x<3.5/m)return mix(l(y,f,i,s),-abs(length(y.xy)-.3+.05*f)+.01-.5*f,smoothstep(3.1/m,3./m,x)*smoothstep(3.4/m,3.5/m,x));else if(x<4./m)return mix(n(y,f,i,s),-abs(length(y.xy)-.3+.05*f)+.01-.5*f,smoothstep(3.6/m,3.5/m,x)*smoothstep(3.9/m,4./m,x));else if(x<5./m)return mix(p(y,f,i,s),-abs(length(y.xy)-.3+.05*f)+.01-.5*f,smoothstep(4.1/m,4./m,x)*smoothstep(4.9/m,5./m,x));else return mix(t(y,f,i,s),-abs(length(y.xy)-.3+.05*f)+.01-.5*f,smoothstep(5.1/m,5./m,x)*smoothstep(5.9/m,6./m,x));}SceneData o(vec3 v){SceneData y=SceneData(0.,v.z+.5,0.,0.,0.,.7,1.);float f=.03,i=mod(v.z,f)-.5*f,x=v.z-i,s=x/f;if(x<=0.){vec3 m=-vec3(c(v,x-f),c(v,x),c(v,x+f));float a=n(n(t(i-f,m.x,.5*f)-.15*f,t(i,m.y,.5*f)-.15*f,.01),t(i+f,m.z,.5*f)-.15*f,.01);y=S(y,SceneData(-1.+3.*abs(s/.5*f),a,0.,0.,0.,.7,1.));}return y;}vec3 w(vec3 y){float f=o(y).dist,s=5e-05;return normalize(vec3(o(y+s*v.xyy).dist,o(y+s*v.yxy).dist,o(y+s*v.yyx).dist)-f);}vec3 z(float y){const int i=4;vec3 f[i]=vec3[i](vec3(1.,.22,.3),v.yyy,vec3(.13,.44,.66),vec3(0.,.8,.73));float x=floor(y),s=mod(x+1.,float(i));return mix(f[int(x)],f[int(s)],fract(y));}bool S(out vec3 f,out vec3 y,inout float m,vec3 x,out SceneData i,vec3 s,vec3 a,out vec3 r){for(int e=0-min(iFrame,0);e<250+min(iFrame,0);++e){y=s+m*x;i=o(y);if(i.dist<.0001){r=w(y);if(i.material==0.)f=v.yyy;else f=z(i.material+u*10.-.1*length(y.xy));f=.2*f+i.diffuse*f*max(dot(normalize(a-y),r),0.)+i.specular*f*pow(max(dot(reflect(normalize(a-y),r),x),0.),2.);return true;}m+=min(i.dist,i.dist>1.?.01:.005);}return false;}void l(out vec4 f,in vec2 s){i=h(iTime*vec3(0.,0.,.6));r=h(iTime*vec3(.7,.9,1.32));float c=mod(iTime,y)-.5*y;e=(iTime-c-.5)/y+smoothstep(-.2*y,.2*y,c);x=smoothstep(-.3*y,0.,c)*smoothstep(.3*y,0.,c);float l=0.,z;vec2 n=(s.xy-.5*iResolution.xy)/iResolution.y;vec3 u=i*v.yzx,w=v.yyy,g=v.yyy,b,T,k,D,F=i*v.xyy,R=v.yyy,C=normalize(n.x*F+n.y*cross(F,normalize(R-u))-u),q=v.zzx;SceneData Z,Y;l=-u.z/C.z;b=u+l*C;if(S(w,b,l,C,Z,u,q,k)){if(Z.reflectivity>0.){z=.002;if(S(g,T,z,reflect(C,k),Y,b,q,D))w=mix(w,g,Z.reflectivity);}if(Z.transmittivity>0.){z=.002;if(S(g,T,z,refract(C,k,.99),Y,b,q,D))w=mix(w,g,Z.transmittivity);}Y=Z;z=l;D=k;if(b.z<=.1){u=b;C=normalize(q-b);z=.01;{float X=1.,W=1e+20;for(int V=0;V<250;++V){b=u+z*C;Z=o(b);if(Z.dist<.0001){X=0.;break;}if(b.z>=.1){X=1.;break;}float U=Z.dist*Z.dist/(2.*W)/12.,Q=sqrt(Z.dist*Z.dist-U*U);X=min(X,100.*Q/max(0.,z-U));W=Z.dist;z+=min(Z.dist,Z.dist>.5?.01:.005);}w=mix(.5*w,w,X);}}}Z=Y;if(Z.material!=0.)g=d(w),g.x=m*p(.5*e*v.xx),w=mix(w,t(g),.5),w=w+w*w+w*w*w;w=mix(w,mix(w,w+w*w+w*w*w,.5),smoothstep(.9,1.4,abs(dot(v.xzx,k))));w=mix(v.yyy,w,smoothstep(0.,1.,iTime)*smoothstep(a,a-1.,iTime));f=mix(texture(iChannel0,s.xy/iResolution.xy),vec4(clamp(w,0.,1.),1.),.5);}void main(){l(gl_FragColor,gl_FragCoord.xy);}