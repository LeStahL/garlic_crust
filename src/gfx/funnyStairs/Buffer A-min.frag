#version 450
uniform sampler2D v;uniform vec2 m;uniform float y;const vec3 f=vec3(1.,0.,-1.);const float x=3.14159,s=1.618,i=60.,z=60./i;mat3 r=mat3(1.),a=mat3(1.);float e,c;const float t=20.;vec3 d[20]=vec3[20](vec3(0,s,1),vec3(0,-s,1),vec3(1,0,s),vec3(-1,0,s),vec3(s,1,0),vec3(-s,1,0),vec3(1,1,1),vec3(-1,1,1),vec3(1,-1,1),vec3(1,1,-1),vec3(0,1,s+1.),vec3(0,-1,s+1.),vec3(s+1.,0,1),vec3(-s-1.,0,1),vec3(1,s+1.,0),vec3(-1,s+1.,0),vec3(sqrt(2.),sqrt(6.),1.),vec3(-sqrt(8.),0.,1.),vec3(sqrt(2.),-sqrt(6.),1.),vec3(0.,0.,-3.));float n(vec3 v,int m,int y,float x,bool f){float s=0.,a;for(int r=m;r<y;++r)a=dot(v,normalize(d[r])),s=max(s,f?abs(a):a);return s-x;}float n(float v,float y,float m){float f=max(m-abs(v-y),0.)/m;return min(v,y)-f*f*f*m*(1./6.);}float p(float v,float f,float y){return v+f-n(v,f,y);}float h(float y,float v,float f){vec2 s=vec2(v,abs(y)-.5*f);return min(max(s.x,s.y),0.)+length(max(s,0.));}void S(in vec2 v,out float f,out vec2 s){vec2 y=vec2(v.x*1.2,v.y+v.x*.6),m=floor(y),a=fract(y);float x=mod(m.x+m.y,3.),c=step(1.,x),o=step(2.,x);vec2 z=step(a.xy,a.yx);f=dot(z,1.-a.yx+c*(a.x+a.y-1.)+o*(a.yx-2.*a.xy));s=m+c-o*z;s=vec2(s.x/1.2,s.y);s=vec2(s.x,s.y-s.x*.6);}mat3 S(in vec3 v){return mat3(f.xyyy,cos(v.x),sin(v.x),0.,-sin(v.x),cos(v.x))*mat3(cos(v.y),0.,-sin(v.y),f.yxy,sin(v.y),0.,cos(v.y))*mat3(cos(v.z),-sin(v.z),0.,sin(v.z),cos(v.z),f.yyyx);}float h(vec2 v){vec3 f=fract(vec3(v.xyx)*.1031);f+=dot(f,f.yzx+33.33);return fract((f.x+f.y)*f.z);}float n(vec2 v){vec2 y=floor(v);v=fract(v);v=smoothstep(f.yy,f.xx,v);vec2 s=vec2(h(y),h(y+f.xy)),x=vec2(h(y+f.yx),h(y+f.xx));s=f.zz+2.*mix(s,x,v.y);return mix(s.x,s.y,v.x);}float S(vec2 v,float m,float x,float f){float s=0.,a=1.,z=0.,i;for(float r=m;r<x;r*=2.)s+=a*n(r*v-2.*y),a*=f,z+=1.;return s*(1.-f)/(1.-pow(f,z));}vec3 p(vec3 v){vec4 f=vec4(1.,2./3.,1./3.,3.);vec3 y=abs(fract(v.xxx+f.xyz)*6.-f.www);return v.z*mix(f.xxx,clamp(y-f.xxx,0.,1.),v.y);}vec3 l(vec3 v){vec4 f=vec4(0.,-1./3.,2./3.,-1.),s=mix(vec4(v.zy,f.wz),vec4(v.yz,f.xy),step(v.z,v.y)),m=mix(vec4(s.xyw,v.x),vec4(v.x,s.yzx),step(s.x,v.x));float x=m.x-min(m.w,m.y),y=1e-10;return vec3(abs(m.z+(m.w-m.y)/(6.*x+y)),x/(m.x+y),m.x);}float S(vec3 v,vec3 y){vec3 f=abs(v)-y;return length(max(f,0.))+min(max(f.x,max(f.y,f.z)),0.);}float h(in vec2 v,in float y){float f=2.*x;vec2 s=mod(vec2(atan(v.y,v.x),length(v)/y),f);float m=abs(s.y-s.x);return y*min(m,f-m);}float l(in vec2 v,in vec2 y,in vec2 f){vec2 s=f-y;return length(v-mix(y,f,clamp(dot(v-y,s)/dot(s,s),0.,1.)));}float h(in vec2 v,in float m,in float y,in float s){s*=2.;float a=atan(v.y,v.x),z=x/s,i=mod(a+x,2.*z),c=mod(round((a+x-i)*.5/z),2.),o=z,r=mix(o,-o,c);vec2 t=m*vec2(cos(z-r),sin(z-r)),n=y*vec2(cos(z+r),sin(z+r)),d=n-t,g=normalize(n-t).yx*f.xz,e=length(v)*vec2(cos(i),sin(i));float S=dot(e-t,d)/dot(d,d),l=mix(1.,-1.,c)*dot(e-t,g);if(S<0.)return sign(l)*length(e-t);else if(S>1.)return sign(l)*length(e-n);else return l;}float o(vec2 v){return max(v.x,v.y);}float w(vec2 v){return min(max(max(max(max(min(max(max(o(abs(vec2(abs(abs(v.x)-.25)-.25,v.y))-vec2(.2)),-o(abs(vec2(v.x+.5,abs(abs(v.y)-.05)-.05))-vec2(.12,.02))),-o(abs(vec2(abs(v.x+.5)-.1,v.y-.05*sign(v.x+.5)))-vec2(.02,.07))),o(abs(vec2(v.x+.5,v.y+.1))-vec2(.08,.04))),-o(abs(vec2(v.x,v.y-.04))-vec2(.02,.08))),-o(abs(vec2(v.x,v.y+.1))-vec2(.02))),-o(abs(vec2(v.x-.5,v.y))-vec2(.08,.12))),-o(abs(vec2(v.x-.5,v.y-.05))-vec2(.12,.07))),o(abs(vec2(v.x-.5,v.y))-vec2(.02,.08)));}struct SceneData{float material,dist,accumulation,reflectivity,transmittivity,specular,diffuse;};SceneData u(float v){return SceneData(1.3,v,1.,.1,.1,.5,1.);}SceneData l(SceneData v,SceneData f){if(v.dist<f.dist)return v;return f;}float b;float l(vec3 v,float y,float f,float s){float m=mix(2.,12.,.5+.5*f)*y*f;mat2 a=mat2(cos(m),sin(m),-sin(m),cos(m));float x=-abs(h(a*(v.xy-vec2(f,s)*.5),abs(f+.1*y),abs(s-.1*y),round(5.+f+s)))+.01-.1*y,i=mod(x,.2)-.189;b=x-i;return i;}float n(vec3 v,float f,float x,float m){mat2 s=mat2(cos(y),sin(y),-sin(y),cos(y));return-abs(h(s*s*v.xy-.3*x,mix(.05,.1,.5+.5*x)))-.3*f+.01*x;}float o(vec3 v,float f,float y,float x){return-1.+S(v.xy-y*.3,3.,10.,.45)-3.*f;}float p(vec3 v,float y,float f,float x){float s=.3;return-abs(mod(w(v.xy-y*.4),s)+.5*s-.4-.2*f-.5*y)+.01+.01*e+.001*y;}float u(vec3 v,float f,float y,float x){vec2 s;float m=3.+3.*y,a;S(m*v.xy,a,s);return-abs(a/m)+.01-.5*f;}float w(vec3 v,float y,float x,float m){const float s=.2;return-n(a*(vec3(v.xy,y)+2.*s*f.yyx*(.5+.5*x)),6,16,s,true);}float n(vec3 v,float s){float x=n(.5*c*f.xx-s),a=n(.5*c*f.xx+1337.-s),m=1.-clamp(y/t,0.,1.),z=6.;if(m<1./z)return mix(l(v,s,x,a),n(v,s,x,a),smoothstep(.8/z,.9/z,m));else if(m<2./z)return mix(n(v,s,x,a),o(v,s,x,a),smoothstep(1.8/z,1.9/z,m));else if(m<3./z)return mix(o(v,s,x,a),p(v,s,x,a),smoothstep(2.8/z,2.9/z,m));else if(m<4./z)return mix(p(v,s,x,a),u(v,s,x,a),smoothstep(3.8/z,3.9/z,m));else if(m<5./z)return mix(u(v,s,x,a),w(v,s,x,a),smoothstep(4.8/z,4.9/z,m));else return w(v,s,x,a);}SceneData g(vec3 v){SceneData f=SceneData(0.,v.z+.5,0.,0.,0.,.7,1.);float s=.03,y=mod(v.z,s)-.5*s,m=v.z-y,a=m/s;if(m<=0.){vec3 x=-vec3(n(v,m-s),n(v,m),n(v,m+s));float z=n(n(h(y-s,x.x,.5*s)-.15*s,h(y,x.y,.5*s)-.15*s,.01),h(y+s,x.z,.5*s)-.15*s,.01);f=l(f,SceneData(-1.+3.*abs(a/.5*s),z,0.,0.,0.,.7,1.));}return f;}vec3 D(vec3 v){float y=g(v).dist,s=5e-05;return normalize(vec3(g(v+s*f.xyy).dist,g(v+s*f.yxy).dist,g(v+s*f.yyx).dist)-y);}vec3 q(float v){const int y=4;vec3 s[y]=vec3[y](vec3(1.,.22,.3),f.yyy,vec3(.13,.44,.66),vec3(0.,.8,.73));float m=floor(v),a=mod(m+1.,float(y));return mix(s[int(m)],s[int(a)],fract(v));}bool D(out vec3 v,out vec3 y,inout float s,vec3 x,out SceneData m,vec3 z,vec3 a,out vec3 i){for(int r=0;r<250;++r){y=z+s*x;m=g(y);if(m.dist<.0001){i=D(y);if(m.material==0.)v=f.yyy;else v=q(m.material+b*10.-.1*length(y.xy));v=.2*v+m.diffuse*v*max(dot(normalize(a-y),i),0.)+m.specular*v*pow(max(dot(reflect(normalize(a-y),i),x),0.),2.);return true;}s+=min(m.dist,m.dist>1.?.01:.005);}return false;}void D(out vec4 s,in vec2 i){r=S(y*vec3(0.,0.,.6));a=S(y*vec3(.7,.9,1.32));float o=mod(y,z)-.5*z;c=(y-o-.5)/z+smoothstep(-.2*z,.2*z,o);e=smoothstep(-.3*z,0.,o)*smoothstep(.3*z,0.,o);float t=0.,b;vec2 d=(i.xy-.5*m.xy)/m.y;vec3 w=r*f.yzx,h,u,k,q,F,C,Z=r*f.xyy,Y=f.yyy,X=normalize(d.x*Z+d.y*cross(Z,normalize(Y-w))-w),W=f.zzx;SceneData V,U;t=-(w.z-.01)/X.z;if(D(h,k,t,X,V,w,W,F)){if(V.reflectivity>0.){b=.002;if(D(u,q,b,reflect(X,F),U,k,W,C))h=mix(h,u,V.reflectivity);}if(V.transmittivity>0.){b=.002;if(D(u,q,b,refract(X,F,.99),U,k,W,C))h=mix(h,u,V.transmittivity);}U=V;b=t;C=F;if(k.z<0.){w=k;X=normalize(W-k);b=.01;{float T=1.,R=1e+20;for(int Q=0;Q<250;++Q){k=w+b*X;V=g(k);if(V.dist<.0001){T=0.;break;}if(k.z>0.){T=1.;break;}float P=V.dist*V.dist/(2.*R)/12.,O=sqrt(V.dist*V.dist-P*P);T=min(T,100.*O/max(0.,b-P));R=V.dist;b+=min(V.dist,V.dist>.5?.01:.005);}h=mix(.5*h,h,T);}}}V=U;if(V.material!=0.)u=l(h),u.x=x*n(.5*c*f.xx),h=mix(h,p(u),.5),h=h+h*h+h*h*h;h=mix(h,mix(h,h+h*h+h*h*h,.5),smoothstep(.9,1.4,abs(dot(f.xzx,F))));s=mix(texture(v,i.xy/m.xy),vec4(clamp(h,0.,1.),1.),.5);}void main(){D(gl_FragColor,gl_FragCoord.xy);}